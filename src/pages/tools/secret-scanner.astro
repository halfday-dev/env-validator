---
import Layout from '../../layouts/Layout.astro';
const title = "Secret Scanner ‚Äî Find Leaked API Keys & Credentials Instantly | Halfday";
const description = "Paste any text to instantly detect leaked API keys, passwords, and tokens. Runs entirely in your browser ‚Äî your data never leaves the page.";
---
<Layout title={title} description={description}>
  <div class="max-w-5xl mx-auto w-full">
    <!-- Trust Banner -->
    <div class="mb-6 flex items-center gap-2 bg-emerald-500/10 border border-emerald-500/20 rounded-lg px-4 py-3 text-emerald-400 text-sm">
      <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
      <span><strong>Your data never leaves your browser.</strong> All scanning runs 100% client-side. No data is sent to any server.</span>
    </div>

    <h1 class="text-3xl font-bold mb-2">Secret & Credential Scanner</h1>
    <p class="text-gray-400 mb-6">Paste any text ‚Äî code, logs, configs, terminal output ‚Äî to detect leaked API keys, passwords, and tokens.</p>

    <!-- Input -->
    <div class="mb-4 flex items-center gap-2">
      <button id="sampleBtn" class="text-sm px-3 py-1.5 rounded-md bg-gray-800 hover:bg-gray-700 text-gray-300 transition">Load Example</button>
      <button id="clearBtn" class="text-sm px-3 py-1.5 rounded-md bg-gray-800 hover:bg-gray-700 text-gray-300 transition">Clear</button>
    </div>
    <textarea id="scanInput" class="w-full h-64 bg-gray-900 border border-gray-700 rounded-lg p-4 font-mono text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent resize-y placeholder-gray-600" placeholder="Paste code, logs, config files, or any text to scan for secrets..."></textarea>

    <!-- Results -->
    <div id="results" class="mt-8 hidden">
      <!-- Summary -->
      <div class="flex flex-col sm:flex-row gap-4 mb-6">
        <div class="flex-1 grid grid-cols-2 sm:grid-cols-3 gap-3">
          <div class="rounded-lg bg-gray-900 border border-gray-800 p-4 text-center">
            <div id="critCount" class="text-2xl font-bold text-red-400">0</div>
            <div class="text-xs text-gray-500 mt-1">Critical</div>
          </div>
          <div class="rounded-lg bg-gray-900 border border-gray-800 p-4 text-center">
            <div id="warnCount" class="text-2xl font-bold text-yellow-400">0</div>
            <div class="text-xs text-gray-500 mt-1">Warnings</div>
          </div>
          <div class="rounded-lg bg-gray-900 border border-gray-800 p-4 text-center col-span-2 sm:col-span-1">
            <div id="scanTime" class="text-2xl font-bold text-gray-400">0ms</div>
            <div class="text-xs text-gray-500 mt-1">Scan Time</div>
          </div>
        </div>
      </div>

      <!-- Findings -->
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Findings</h2>
        <button id="copyRedactedBtn" class="text-sm px-3 py-1.5 rounded-md bg-gray-800 hover:bg-gray-700 text-gray-300 transition flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
          Copy Redacted
        </button>
      </div>
      <div id="findingsList" class="space-y-2"></div>

      <!-- Cross-link -->
      <div class="mt-8 text-sm text-gray-500">
        Working with <code>.env</code> files specifically? Try our <a href="/tools/env-validator" class="text-emerald-400 hover:underline">ENV Validator</a> for targeted analysis with security scoring.
      </div>
    </div>
  </div>

  <script>
    import { scan } from '../../lib/secret-scanner.js';

    function getSampleText() {
      const akia = 'AKIA' + 'IOSFODNN7EXAMPLE';
      const ghToken = 'ghp_' + 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' + 'abcdefghij';
      const glToken = 'glpat-' + 'ABCDEFGHIJKLMNOPabcd';
      const npmToken = 'npm_' + 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghij';

      return `# Application Config
DATABASE_URL=postgres://admin:password123@db.example.com:5432/myapp
REDIS_URL=redis://:supersecret@cache.example.com:6379/0

# AWS Credentials
export AWS_ACCESS_KEY_ID="${akia}"
export AWS_SECRET_ACCESS_KEY="wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"

# GitHub Token in script
curl -H "Authorization: token ${ghToken}" https://api.github.com

# Private key leaked in log
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA0Z3VS5JJcds3xfn/ygWyF8PbnGy5AoV5B2RYNdBx...

# npm token in .npmrc
//registry.npmjs.org/:_authToken=${npmToken}

# GitLab
GITLAB_DEPLOY_TOKEN=${glToken}

# MongoDB connection
mongo_uri = "mongodb+srv://appuser:S3cretP4ss@cluster0.example.net/prod?retryWrites=true"

# High entropy string in config
API_SIGNING_KEY=a8f2k9Lm3nPq7rSt1uVw5xYz0AbCdEfGhIjKl`;
    }

    const severityConfig = {
      critical: { bg: 'bg-red-500/10', border: 'border-red-500/20', badge: 'bg-red-500/20 text-red-400', icon: 'üî¥' },
      warning: { bg: 'bg-yellow-500/10', border: 'border-yellow-500/20', badge: 'bg-yellow-500/20 text-yellow-400', icon: 'üü°' },
    };

    let lastResult = null;

    function renderResults(result) {
      lastResult = result;
      const resultsEl = document.getElementById('results');
      const list = document.getElementById('findingsList');
      const input = document.getElementById('scanInput');

      if (!input.value.trim()) {
        resultsEl.classList.add('hidden');
        return;
      }

      resultsEl.classList.remove('hidden');
      document.getElementById('critCount').textContent = result.counts.critical;
      document.getElementById('warnCount').textContent = result.counts.warning;
      document.getElementById('scanTime').textContent = result.scanTimeMs + 'ms';

      if (result.findings.length === 0) {
        list.innerHTML = '<p class="text-gray-500 text-sm">‚úÖ No secrets detected. Your text looks clean!</p>';
        return;
      }

      const crits = result.findings.filter(f => f.severity === 'critical');
      const warns = result.findings.filter(f => f.severity === 'warning');

      list.innerHTML = [...crits, ...warns].map(f => {
        const c = severityConfig[f.severity];
        const truncated = f.matchedText.length > 40 ? f.matchedText.slice(0, 40) + '...' : f.matchedText;
        const escaped = truncated.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        return `<div class="rounded-lg ${c.bg} border ${c.border} p-4">
          <div class="flex items-start gap-3">
            <span class="text-sm mt-0.5">${c.icon}</span>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 flex-wrap">
                <span class="text-sm font-medium text-gray-200">${f.name}</span>
                <span class="text-xs px-2 py-0.5 rounded-full ${c.badge}">${f.severity}</span>
                <span class="text-xs text-gray-500">Line ${f.line}</span>
              </div>
              <code class="text-xs text-gray-400 mt-1 block font-mono break-all">${escaped}</code>
              <p class="text-xs text-gray-500 mt-1">üí° ${f.fix}</p>
            </div>
          </div>
        </div>`;
      }).join('');

      if (result.findings.length >= 500) {
        list.innerHTML += '<p class="text-yellow-400 text-sm mt-2">‚ö†Ô∏è 500+ findings ‚Äî showing first 500.</p>';
      }
    }

    const input = document.getElementById('scanInput');
    let debounce;
    input.addEventListener('input', () => {
      clearTimeout(debounce);
      debounce = setTimeout(() => renderResults(scan(input.value)), 150);
    });

    document.getElementById('sampleBtn').addEventListener('click', () => {
      const sample = getSampleText();
      input.value = sample;
      renderResults(scan(sample));
    });

    document.getElementById('clearBtn').addEventListener('click', () => {
      input.value = '';
      document.getElementById('results').classList.add('hidden');
      lastResult = null;
    });

    document.getElementById('copyRedactedBtn').addEventListener('click', () => {
      if (!lastResult) return;
      navigator.clipboard.writeText(lastResult.redactedText).then(() => {
        const btn = document.getElementById('copyRedactedBtn');
        const orig = btn.innerHTML;
        btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Copied!';
        setTimeout(() => { btn.innerHTML = orig; }, 2000);
      });
    });
  </script>
</Layout>
