---
import Layout from '../../layouts/Layout.astro';
---
<Layout title="ENV Validator & Security Scanner â€” Halfday">
  <div class="max-w-5xl mx-auto w-full">
    <!-- Trust Banner -->
    <div class="mb-6 flex items-center gap-2 bg-emerald-500/10 border border-emerald-500/20 rounded-lg px-4 py-3 text-emerald-400 text-sm">
      <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
      <span><strong>Your secrets never leave your browser.</strong> All analysis runs 100% client-side. No data is sent to any server.</span>
    </div>

    <h1 class="text-3xl font-bold mb-2">.env Validator & Security Scanner</h1>
    <p class="text-gray-400 mb-6">Paste your .env file to detect leaked API keys, weak passwords, and common misconfigurations.</p>

    <!-- Input -->
    <div class="mb-4 flex items-center gap-2">
      <button id="sampleBtn" class="text-sm px-3 py-1.5 rounded-md bg-gray-800 hover:bg-gray-700 text-gray-300 transition">Load Sample</button>
      <button id="clearBtn" class="text-sm px-3 py-1.5 rounded-md bg-gray-800 hover:bg-gray-700 text-gray-300 transition">Clear</button>
    </div>
    <textarea id="envInput" class="w-full h-64 bg-gray-900 border border-gray-700 rounded-lg p-4 font-mono text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent resize-y placeholder-gray-600" placeholder="Paste your .env file here..."></textarea>

    <!-- Results -->
    <div id="results" class="mt-8 hidden">
      <!-- Score -->
      <div class="flex flex-col sm:flex-row gap-4 mb-6">
        <div id="scoreCard" class="flex-shrink-0 w-full sm:w-48 rounded-lg border border-gray-800 bg-gray-900 p-6 flex flex-col items-center justify-center">
          <div class="text-xs uppercase tracking-wider text-gray-500 mb-1">Security Score</div>
          <div id="scoreGrade" class="text-6xl font-black"></div>
          <div id="scoreLabel" class="text-sm mt-1"></div>
        </div>
        <div class="flex-1 grid grid-cols-3 gap-3">
          <div class="rounded-lg bg-gray-900 border border-gray-800 p-4 text-center">
            <div id="critCount" class="text-2xl font-bold text-red-400">0</div>
            <div class="text-xs text-gray-500 mt-1">Critical</div>
          </div>
          <div class="rounded-lg bg-gray-900 border border-gray-800 p-4 text-center">
            <div id="warnCount" class="text-2xl font-bold text-yellow-400">0</div>
            <div class="text-xs text-gray-500 mt-1">Warnings</div>
          </div>
          <div class="rounded-lg bg-gray-900 border border-gray-800 p-4 text-center">
            <div id="infoCount" class="text-2xl font-bold text-blue-400">0</div>
            <div class="text-xs text-gray-500 mt-1">Info</div>
          </div>
        </div>
      </div>

      <!-- Findings -->
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Findings</h2>
        <button id="copyBtn" class="text-sm px-3 py-1.5 rounded-md bg-gray-800 hover:bg-gray-700 text-gray-300 transition flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
          Copy Results
        </button>
      </div>
      <div id="findingsList" class="space-y-2"></div>

      <!-- Gitignore suggestion -->
      <div id="gitignoreSection" class="mt-8 hidden">
        <h2 class="text-lg font-semibold mb-3">Suggested .gitignore entries</h2>
        <pre id="gitignoreSuggest" class="bg-gray-900 border border-gray-800 rounded-lg p-4 font-mono text-sm text-gray-300 overflow-x-auto"></pre>
      </div>
    </div>
  </div>

  <script>
    import { patterns, weakPasswords, analyze, computeScore } from '../../lib/scanner.js';

    const sampleEnv = `# Database
DATABASE_URL=postgres://admin:password123@localhost:5432/myapp
REDIS_URL=redis://:supersecret@cache.example.com:6379

# AWS
AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
AWS_REGION=us-east-1

# Stripe
STRIPE_SECRET_KEY=sk_live_51HG8eXAMPLEKEYabc123def456
STRIPE_PUBLISHABLE_KEY=pk_live_51HG8eXAMPLEKEYxyz789

# OpenAI
OPENAI_API_KEY=sk-proj-abc123def456ghi789jkl012mno345pqr678stu901vwx

# GitHub
GITHUB_TOKEN=ghp_ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefgh

# Slack
SLACK_BOT_TOKEN=xoxb-1234567890-1234567890123-ABCDEFGHIJKLMNOPQRSTUVw

# SendGrid
SENDGRID_API_KEY=SG.abcdefghijklmnopqrstuv.ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopq

# App Config
APP_NAME=My Cool App
DEBUG=true
PORT=3000
NODE_ENV=development
API_URL=https://api.example.com
JWT_SECRET=changeme

# Duplicate key
DEBUG=false

# Empty values
EMPTY_VAR=
ANOTHER_EMPTY=

# Unquoted value with spaces
APP_DESCRIPTION=My awesome app with spaces

# Commented out secret
# OLD_API_KEY=sk_live_oldkey123456789012345678
# PREVIOUS_DB_PASSWORD=oldpassword123

# npm
NPM_TOKEN=npm_ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefgh

# GitLab
GITLAB_TOKEN=glpat-ABCDEFGHIJKLMNOPabcd

# Private key (BAD!)
PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----\\nMIIEpA..."
`;

    const severityConfig = {
      critical: { bg: 'bg-red-500/10', border: 'border-red-500/20', badge: 'bg-red-500/20 text-red-400', icon: 'ðŸ”´' },
      warning: { bg: 'bg-yellow-500/10', border: 'border-yellow-500/20', badge: 'bg-yellow-500/20 text-yellow-400', icon: 'ðŸŸ¡' },
      info: { bg: 'bg-blue-500/10', border: 'border-blue-500/20', badge: 'bg-blue-500/20 text-blue-400', icon: 'ðŸ”µ' },
    };

    function render(findings) {
      const results = document.getElementById('results');
      const list = document.getElementById('findingsList');
      if (!findings || findings.length === 0) {
        if (document.getElementById('envInput').value.trim()) {
          results.classList.remove('hidden');
          document.getElementById('scoreGrade').textContent = 'A';
          document.getElementById('scoreGrade').className = 'text-6xl font-black text-emerald-400';
          document.getElementById('scoreLabel').textContent = 'No issues found!';
          document.getElementById('scoreLabel').className = 'text-sm mt-1 text-emerald-400';
          document.getElementById('scoreCard').className = 'flex-shrink-0 w-full sm:w-48 rounded-lg border border-emerald-500/30 bg-gray-900 p-6 flex flex-col items-center justify-center';
          document.getElementById('critCount').textContent = '0';
          document.getElementById('warnCount').textContent = '0';
          document.getElementById('infoCount').textContent = '0';
          list.innerHTML = '<p class="text-gray-500 text-sm">âœ… No issues detected. Your .env file looks clean!</p>';
          document.getElementById('gitignoreSection').classList.remove('hidden');
        } else {
          results.classList.add('hidden');
        }
        return;
      }

      results.classList.remove('hidden');
      const score = computeScore(findings);
      document.getElementById('scoreGrade').textContent = score.grade;
      document.getElementById('scoreGrade').className = `text-6xl font-black ${score.color}`;
      document.getElementById('scoreLabel').textContent = score.label;
      document.getElementById('scoreLabel').className = `text-sm mt-1 ${score.color}`;
      document.getElementById('scoreCard').className = `flex-shrink-0 w-full sm:w-48 rounded-lg border ${score.bg} bg-gray-900 p-6 flex flex-col items-center justify-center`;

      const crits = findings.filter(f => f.severity === 'critical');
      const warns = findings.filter(f => f.severity === 'warning');
      const infos = findings.filter(f => f.severity === 'info');
      document.getElementById('critCount').textContent = crits.length;
      document.getElementById('warnCount').textContent = warns.length;
      document.getElementById('infoCount').textContent = infos.length;

      list.innerHTML = [...crits, ...warns, ...infos].map(f => {
        const c = severityConfig[f.severity];
        return `<div class="rounded-lg ${c.bg} border ${c.border} p-4">
          <div class="flex items-start gap-3">
            <span class="text-sm mt-0.5">${c.icon}</span>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 flex-wrap">
                <span class="text-sm font-medium text-gray-200">${f.name}</span>
                <span class="text-xs px-2 py-0.5 rounded-full ${c.badge}">${f.severity}</span>
                <span class="text-xs text-gray-500">Line ${f.line}</span>
              </div>
              <p class="text-sm text-gray-400 mt-1">${f.desc}</p>
              <p class="text-xs text-gray-500 mt-1">ðŸ’¡ ${f.fix}</p>
            </div>
          </div>
        </div>`;
      }).join('');

      document.getElementById('gitignoreSection').classList.remove('hidden');
    }

    // Gitignore suggestions
    document.getElementById('gitignoreSuggest').textContent = `.env
.env.local
.env.production
.env.*.local
.env.development.local
.env.test.local
.env.production.local`;

    // Event listeners
    const input = document.getElementById('envInput');
    let debounce;
    input.addEventListener('input', () => {
      clearTimeout(debounce);
      debounce = setTimeout(() => render(analyze(input.value)), 150);
    });

    document.getElementById('sampleBtn').addEventListener('click', () => {
      input.value = sampleEnv;
      render(analyze(sampleEnv));
    });

    document.getElementById('clearBtn').addEventListener('click', () => {
      input.value = '';
      document.getElementById('results').classList.add('hidden');
    });

    document.getElementById('copyBtn').addEventListener('click', () => {
      const findings = analyze(input.value);
      if (!findings) return;
      const score = computeScore(findings);
      const text = `ENV Validator Report â€” Score: ${score.grade} (${score.label})\n` +
        `Critical: ${findings.filter(f=>f.severity==='critical').length} | Warnings: ${findings.filter(f=>f.severity==='warning').length} | Info: ${findings.filter(f=>f.severity==='info').length}\n\n` +
        findings.map(f => `[${f.severity.toUpperCase()}] Line ${f.line}: ${f.name} â€” ${f.desc}`).join('\n') +
        '\n\nScanned with halfday.dev/tools/env-validator';
      navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById('copyBtn');
        btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Copied!';
        setTimeout(() => {
          btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg> Copy Results';
        }, 2000);
      });
    });
  </script>
</Layout>
